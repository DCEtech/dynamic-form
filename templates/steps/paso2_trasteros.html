<!-- Paso 2: Informaci√≥n de Trasteros -->
<div class="step-content">
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info d-flex align-items-center" role="alert">
                <i class="bi bi-info-circle me-3 fs-4"></i>
                <div>
                    <strong>Configuraci√≥n de Trasteros</strong><br>
                    Configure los trasteros disponibles con sus caracter√≠sticas y precios.
                    Puede agregar m√∫ltiples trasteros usando el bot√≥n "Agregar Trastero".
                </div>
            </div>
        </div>
    </div>

    <!-- Bot√≥n para agregar trastero -->
    <div class="row mb-4">
        <div class="col-12">
            <button type="button" class="btn btn-success" id="add-trastero">
                <i class="bi bi-plus-circle me-2"></i>Agregar Trastero
            </button>
        </div>
    </div>

    <!-- Contenedor de trasteros -->
    <div id="trasteros-container">
        <!-- Template de trastero (se clonar√° din√°micamente) -->
        <div class="trastero-item card mb-4" style="display: none;" id="trastero-template">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-archive me-2"></i>
                    Trastero <span class="trastero-number">1</span>
                </h6>
                <button type="button" class="btn btn-sm btn-outline-danger remove-trastero">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">
                            N√∫mero de Trastero *
                            <i class="bi bi-question-circle tooltip-icon ms-1"
                               data-bs-toggle="tooltip"
                               title="N√∫mero identificativo √∫nico del trastero"></i>
                        </label>
                        <input type="text"
                               class="form-control trastero-numero"
                               name="numero_trastero"
                               placeholder="Ej: T001"
                               required>
                        <div class="invalid-feedback">
                            Por favor, ingrese el n√∫mero del trastero.
                        </div>
                    </div>

                    <div class="col-md-3 mb-3">
                        <label class="form-label">
                            Metros Cuadrados *
                            <i class="bi bi-question-circle tooltip-icon ms-1"
                               data-bs-toggle="tooltip"
                               title="Superficie en metros cuadrados (m¬≤)"></i>
                        </label>
                        <div class="input-group">
                            <input type="number"
                                   class="form-control trastero-metros"
                                   name="metros"
                                   placeholder="0.00"
                                   step="0.01"
                                   min="0"
                                   required>
                            <span class="input-group-text">m¬≤</span>
                        </div>
                        <div class="invalid-feedback">
                            Por favor, ingrese los metros cuadrados.
                        </div>
                    </div>

                    <div class="col-md-3 mb-3">
                        <label class="form-label">
                            Metros C√∫bicos
                            <i class="bi bi-question-circle tooltip-icon ms-1"
                               data-bs-toggle="tooltip"
                               title="Volumen en metros c√∫bicos (m¬≥) - opcional"></i>
                        </label>
                        <div class="input-group">
                            <input type="number"
                                   class="form-control trastero-cubicos"
                                   name="metros_cubicos"
                                   placeholder="0.00"
                                   step="0.01"
                                   min="0">
                            <span class="input-group-text">m¬≥</span>
                        </div>
                    </div>

                    <div class="col-md-3 mb-3">
                        <label class="form-label">
                            Precio sin IVA *
                            <i class="bi bi-question-circle tooltip-icon ms-1"
                               data-bs-toggle="tooltip"
                               title="Precio mensual sin IVA incluido"></i>
                        </label>
                        <div class="input-group">
                            <input type="number"
                                   class="form-control trastero-precio-sin-iva"
                                   name="precio_sin_iva"
                                   placeholder="0.00"
                                   step="0.01"
                                   min="0"
                                   required>
                            <span class="input-group-text">‚Ç¨</span>
                        </div>
                        <div class="invalid-feedback">
                            Por favor, ingrese el precio sin IVA.
                        </div>
                    </div>

                    <div class="col-md-3 mb-3">
                        <label class="form-label">
                            Precio con IVA
                            <i class="bi bi-question-circle tooltip-icon ms-1"
                               data-bs-toggle="tooltip"
                               title="Se calcula autom√°ticamente (21% IVA)"></i>
                        </label>
                        <div class="input-group">
                            <input type="number"
                                   class="form-control trastero-precio-con-iva"
                                   name="precio_con_iva"
                                   placeholder="0.00"
                                   step="0.01"
                                   readonly>
                            <span class="input-group-text">‚Ç¨</span>
                        </div>
                        <small class="text-muted">Calculado autom√°ticamente (21% IVA)</small>
                    </div>

                    <div class="col-md-3 mb-3">
                        <label class="form-label">
                            Fianza
                            <i class="bi bi-question-circle tooltip-icon ms-1"
                               data-bs-toggle="tooltip"
                               title="Importe de la fianza requerida"></i>
                        </label>
                        <div class="input-group">
                            <input type="number"
                                   class="form-control trastero-fianza"
                                   name="fianza"
                                   placeholder="0.00"
                                   step="0.01"
                                   min="0">
                            <span class="input-group-text">‚Ç¨</span>
                        </div>
                    </div>


                </div>

                {#                <!-- Resumen del trastero -->#}
                {#                <div class="row mt-3">#}
                {#                    <div class="col-12">#}
                {#                        <div class="alert alert-light border">#}
                {#                            <div class="row text-center">#}
                {#                                <div class="col-md-2">#}
                {#                                    <strong>N√∫mero</strong><br>#}
                {#                                    <span class="text-primary trastero-resumen-numero">-</span>#}
                {#                                </div>#}
                {#                                <div class="col-md-2">#}
                {#                                    <strong>Superficie</strong><br>#}
                {#                                    <span class="text-primary trastero-resumen-metros">0 m¬≤</span>#}
                {#                                </div>#}
                {#                                <div class="col-md-2">#}
                {#                                    <strong>Volumen</strong><br>#}
                {#                                    <span class="text-primary trastero-resumen-cubicos">0 m¬≥</span>#}
                {#                                </div>#}
                {#                                <div class="col-md-2">#}
                {#                                    <strong>Sin IVA</strong><br>#}
                {#                                    <span class="text-success trastero-resumen-sin-iva">0.00 ‚Ç¨</span>#}
                {#                                </div>#}
                {#                                <div class="col-md-2">#}
                {#                                    <strong>Con IVA</strong><br>#}
                {#                                    <span class="text-success trastero-resumen-con-iva">0.00 ‚Ç¨</span>#}
                {#                                </div>#}
                {#                                <div class="col-md-2">#}
                {#                                    <strong>Fianza</strong><br>#}
                {#                                    <span class="text-warning trastero-resumen-fianza">0.00 ‚Ç¨</span>#}
                {#                                </div>#}
                {#                            </div>#}
                {#                        </div>#}
                {#                    </div>#}
                {#                </div>#}
            </div>
        </div>
    </div>

    <!-- Modal: Agregar m√∫ltiples trasteros -->
    <div class="modal fade" id="modalTrasteros" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-archive me-2"></i>
                        Agregar trasteros en lote
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="row">

                        <!-- Metros cuadrados -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label">
                                Metros Cuadrados *
                            </label>
                            <div class="input-group">
                                <input type="number"
                                       class="form-control"
                                       id="modal_trastero_metros"
                                       step="0.01"
                                       min="0"
                                       required>
                                <span class="input-group-text">m¬≤</span>
                            </div>
                        </div>

                        <!-- Metros c√∫bicos -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label">
                                Metros C√∫bicos
                            </label>
                            <div class="input-group">
                                <input type="number"
                                       class="form-control"
                                       id="modal_trastero_cubicos"
                                       step="0.01"
                                       min="0">
                                <span class="input-group-text">m¬≥</span>
                            </div>
                        </div>

                        <!-- Precio sin IVA -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label">
                                Precio sin IVA *
                            </label>
                            <div class="input-group">
                                <input type="number"
                                       class="form-control"
                                       id="modal_trastero_precio"
                                       step="0.01"
                                       min="0"
                                       required>
                                <span class="input-group-text">‚Ç¨</span>
                            </div>
                        </div>

                        <!-- Fianza -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label">
                                Fianza
                            </label>
                            <div class="input-group">
                                <input type="number"
                                       class="form-control"
                                       id="modal_trastero_fianza"
                                       step="0.01"
                                       min="0">
                                <span class="input-group-text">‚Ç¨</span>
                            </div>
                        </div>

                        <!-- Cantidad -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label">
                                Cantidad de trasteros *
                            </label>
                            <input type="number"
                                   class="form-control"
                                   id="modal_trastero_cantidad"
                                   min="1"
                                   value="1"
                                   required>
                        </div>

                    </div>

                    <div class="alert alert-info mt-2">
                        Se <span id="texto-trasteros-verbo">crear√°n</span>
                        <strong><span id="texto-trasteros-cantidad">1</span> trastero<span
                                id="texto-trasteros-plural">s</span></strong>
                        con estas mismas caracter√≠sticas.
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-outline-secondary"
                            data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="button"
                            class="btn btn-primary"
                            id="btnConfirmarTrasteros">
                        Crear trasteros
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- Mensaje cuando no hay trasteros -->
    <div id="no-trasteros-message" class="text-center py-5">
        <i class="bi bi-archive display-1 text-muted mb-3"></i>
        <h5 class="text-muted">No hay trasteros configurados</h5>
        <p class="text-muted">Haga clic en "Agregar Trastero" para comenzar a configurar los trasteros disponibles.</p>
    </div>

    {#    <!-- Resumen total -->#}
    {#    <div id="resumen-total" class="card bg-primary text-white mt-4" style="display: none;">#}
    {#        <div class="card-body">#}
    {#            <h5 class="card-title">#}
    {#                <i class="bi bi-calculator me-2"></i>Resumen Total#}
    {#            </h5>#}
    {#            <div class="row text-center">#}
    {#                <div class="col-md-3">#}
    {#                    <h6>Total Trasteros</h6>#}
    {#                    <h4 id="total-trasteros">0</h4>#}
    {#                </div>#}
    {#                <div class="col-md-3">#}
    {#                    <h6>Superficie Total</h6>#}
    {#                    <h4 id="total-superficie">0 m¬≤</h4>#}
    {#                </div>#}
    {#                <div class="col-md-3">#}
    {#                    <h6>Ingresos Mensuales (sin IVA)</h6>#}
    {#                    <h4 id="total-ingresos-sin-iva">0.00 ‚Ç¨</h4>#}
    {#                </div>#}
    {#                <div class="col-md-3">#}
    {#                    <h6>Ingresos Mensuales (con IVA)</h6>#}
    {#                    <h4 id="total-ingresos-con-iva">0.00 ‚Ç¨</h4>#}
    {#                </div>#}
    {#            </div>#}
    {#        </div>#}
    {#    </div>#}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let trasteroCounter = 0;
        const container = document.getElementById('trasteros-container');
        const template = document.getElementById('trastero-template');
        const emptyMessage = document.getElementById('no-trasteros-message');


        const cantidadInput = document.getElementById('modal_trastero_cantidad');
        const textoCantidad = document.getElementById('texto-trasteros-cantidad');
        const textoPlural = document.getElementById('texto-trasteros-plural');
        const textoVerbo = document.getElementById('texto-trasteros-verbo');

        function actualizarTextoCantidad() {
            let cantidad = parseInt(cantidadInput.value) || 1;

            if (cantidad < 1) {
                cantidad = 1;
                cantidadInput.value = 1;
            }

            textoCantidad.textContent = cantidad;

            if (cantidad === 1) {
                textoPlural.style.display = 'none';
                textoVerbo.textContent = 'crear√°';
            } else {
                textoPlural.style.display = 'inline';
                textoVerbo.textContent = 'crear√°n';
            }
        }

        cantidadInput.addEventListener('input', actualizarTextoCantidad);
        cantidadInput.addEventListener('change', actualizarTextoCantidad);

        // Inicializar al abrir el modal
        actualizarTextoCantidad();

        // =========================
        // Crear trastero
        // =========================
        function addTrastero(data = null) {
            trasteroCounter++;

            const el = template.cloneNode(true);
            el.id = `trastero-${trasteroCounter}`;
            el.style.display = 'block';

            el.querySelector('.trastero-number').textContent = trasteroCounter;

            // Indexar names
            el.querySelectorAll('input, textarea').forEach(input => {
                const name = input.getAttribute('name');
                if (name) {
                    input.setAttribute(
                        'name',
                        `trasteros[${trasteroCounter - 1}][${name}]`
                    );
                }
            });

            // Cargar datos guardados
            if (data) {
                el.querySelector('.trastero-numero').value = data.numero_trastero || '';
                el.querySelector('.trastero-metros').value = data.metros || '';
                el.querySelector('.trastero-cubicos').value = data.metros_cubicos || '';
                el.querySelector('.trastero-precio-sin-iva').value = data.precio_sin_iva || '';
                el.querySelector('.trastero-precio-con-iva').value = data.precio_con_iva || '';
                el.querySelector('.trastero-fianza').value = data.fianza || '';
            }

            // Eliminar
            el.querySelector('.remove-trastero').addEventListener('click', () => {
                el.remove();
                updateEmptyMessage();
            });

            container.appendChild(el);
            setupEvents(el);
            updateEmptyMessage();
        }

        function crearTrasterosDesdeModal() {

            const cantidad = parseInt(
                document.getElementById('modal_trastero_cantidad').value
            );

            if (!cantidad || cantidad < 1) {
                alert('Ingrese una cantidad v√°lida de trasteros');
                return;
            }

            const dataBase = {
                metros: document.getElementById('modal_trastero_metros').value,
                metros_cubicos: document.getElementById('modal_trastero_cubicos').value,
                precio_sin_iva: document.getElementById('modal_trastero_precio').value,
                precio_con_iva: (
                    parseFloat(document.getElementById('modal_trastero_precio').value || 0) * 1.21
                ).toFixed(2),
                fianza: document.getElementById('modal_trastero_fianza').value
            };

            for (let i = 0; i < cantidad; i++) {
                addTrastero({
                    ...dataBase,
                    numero_trastero: `T${String(trasteroCounter + 1).padStart(3, '0')}`
                });
            }

            // Cerrar modal
            const modalEl = document.getElementById('modalTrasteros');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            // Limpiar campos del modal
            document.getElementById('modal_trastero_metros').value = '';
            document.getElementById('modal_trastero_cubicos').value = '';
            document.getElementById('modal_trastero_precio').value = '';
            document.getElementById('modal_trastero_fianza').value = '';
            document.getElementById('modal_trastero_cantidad').value = 1;
        }


        // =========================
        // Eventos
        // =========================
        function setupEvents(el) {
            const sinIva = el.querySelector('.trastero-precio-sin-iva');
            const conIva = el.querySelector('.trastero-precio-con-iva');

            sinIva.addEventListener('input', () => {
                const v = parseFloat(sinIva.value) || 0;
                conIva.value = (v * 1.21).toFixed(2);
                updateEmptyMessage();
            });

            el.querySelectorAll('input, textarea').forEach(i =>
                i.addEventListener('input', updateEmptyMessage)
            );
        }

        // =========================
        // Estado visual
        // =========================


        // =========================
        // Resumen total
        // =========================
        function updateEmptyMessage() {
            const trasteros = container.querySelectorAll(
                '.trastero-item:not(#trastero-template)'
            );

            emptyMessage.style.display = trasteros.length === 0
                ? 'block'
                : 'none';
        }

        // =========================
        // üî• REHIDRATAR DESDE BACKEND
        // =========================

        const data = window.formularioData?.datosFormulario?.info_trasteros || [];

        if (Array.isArray(data) && data.length > 0) {
            data.forEach(t => addTrastero(t));

        }

        // Bot√≥n agregar
        document
            .getElementById('add-trastero')
            .addEventListener('click', () => {
                const modalEl = document.getElementById('modalTrasteros');
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            });

        document
            .getElementById('btnConfirmarTrasteros')
            .addEventListener('click', crearTrasterosDesdeModal);
    });
</script>
