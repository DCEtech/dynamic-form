<!-- Paso 5: Niveles de Acceso -->
<div class="step-content">
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info d-flex align-items-center" role="alert">
                <i class="bi bi-info-circle me-3 fs-4"></i>
                <div>
                    <strong>Configuraci칩n de Niveles de Acceso</strong><br>
                    Defina los diferentes niveles de acceso y permisos para controlar qu칠 puertas o 치reas pueden acceder
                    los usuarios.
                    Cada nivel puede tener m칰ltiples puertas asignadas.
                </div>
            </div>
        </div>
    </div>

    <!-- Bot칩n para agregar nivel -->
    <div class="row mb-4">
        <div class="col-12">
            <button type="button" class="btn btn-success" id="add-nivel">
                <i class="bi bi-plus-circle me-2"></i>Agregar Nivel de Acceso
            </button>
        </div>
    </div>

    <!-- Contenedor de niveles -->
    <div id="niveles-container">
        <!-- Template de nivel (se clonar치 din치micamente) -->
        <div class="nivel-item card mb-4" style="display: none;" id="nivel-template">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-key me-2"></i>
                    Nivel de Acceso <span class="nivel-number">1</span>
                </h6>
                <button type="button" class="btn btn-sm btn-outline-danger remove-nivel">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">
                            Nombre del Nivel *
                            <i class="bi bi-question-circle tooltip-icon ms-1"
                               data-bs-toggle="tooltip"
                               title="Nombre descriptivo del nivel de acceso"></i>
                        </label>
                        <input type="text"
                               class="form-control nivel-nombre"
                               name="nombre_nivel"
                               placeholder="Ej: Administrador, Usuario B치sico, Supervisor"
                               required>
                        <div class="invalid-feedback">
                            Por favor, ingrese el nombre del nivel.
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">
                            Prioridad del Nivel
                            <i class="bi bi-question-circle tooltip-icon ms-1"
                               data-bs-toggle="tooltip"
                               title="Nivel de prioridad (1=m치xima, 10=m칤nima)"></i>
                        </label>
                        <select class="form-select nivel-prioridad" name="prioridad_nivel">
                            <option value="1">1 - M치xima Prioridad</option>
                            <option value="2">2 - Muy Alta</option>
                            <option value="3">3 - Alta</option>
                            <option value="4">4 - Media-Alta</option>
                            <option value="5" selected>5 - Media</option>
                            <option value="6">6 - Media-Baja</option>
                            <option value="7">7 - Baja</option>
                            <option value="8">8 - Muy Baja</option>
                            <option value="9">9 - M칤nima</option>
                            <option value="10">10 - Sin Prioridad</option>
                        </select>
                    </div>

                    <div class="col-12 mb-3">
                        <label class="form-label">
                            Descripci칩n del Nivel *
                            <i class="bi bi-question-circle tooltip-icon ms-1"
                               data-bs-toggle="tooltip"
                               title="Descripci칩n detallada de qu칠 permisos incluye este nivel"></i>
                        </label>
                        <textarea class="form-control nivel-descripcion"
                                  name="descripcion_nivel"
                                  rows="3"
                                  placeholder="Ej: Acceso completo a todas las 치reas, incluyendo administraci칩n y configuraci칩n del sistema..."
                                  required></textarea>
                        <div class="invalid-feedback">
                            Por favor, ingrese una descripci칩n del nivel.
                        </div>
                        <div class="form-text">
                            <span class="char-count">0</span>/500 caracteres
                        </div>
                    </div>
                </div>

                <!-- Configuraci칩n de Puertas -->
                <div class="row mb-3">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-door-open me-2"></i>Puertas y Accesos
                        </h6>
                    </div>

                    <div class="col-12 mb-3">
                        <label class="form-label">
                            Puertas Permitidas
                            <i class="bi bi-question-circle tooltip-icon ms-1"
                               data-bs-toggle="tooltip"
                               title="Seleccione las puertas a las que este nivel tendr치 acceso"></i>
                        </label>
                        <div class="puertas-grid">
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="puerta_principal"
                                               id="puerta_principal">
                                        <label class="form-check-label" for="puerta_principal">
                                            <i class="bi bi-door-closed me-1"></i>Puerta Principal
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="puerta_trasera"
                                               id="puerta_trasera">
                                        <label class="form-check-label" for="puerta_trasera">
                                            <i class="bi bi-door-closed me-1"></i>Puerta Trasera
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="puerta_garaje"
                                               id="puerta_garaje">
                                        <label class="form-check-label" for="puerta_garaje">
                                            <i class="bi bi-car-front me-1"></i>Garaje
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="puerta_oficina"
                                               id="puerta_oficina">
                                        <label class="form-check-label" for="puerta_oficina">
                                            <i class="bi bi-building me-1"></i>Oficina
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="puerta_almacen"
                                               id="puerta_almacen">
                                        <label class="form-check-label" for="puerta_almacen">
                                            <i class="bi bi-archive me-1"></i>Almac칠n
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="puerta_emergencia"
                                               id="puerta_emergencia">
                                        <label class="form-check-label" for="puerta_emergencia">
                                            <i class="bi bi-exclamation-triangle me-1"></i>Emergencia
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="puerta_sotano"
                                               id="puerta_sotano">
                                        <label class="form-check-label" for="puerta_sotano">
                                            <i class="bi bi-arrow-down me-1"></i>S칩tano
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="puerta_azotea"
                                               id="puerta_azotea">
                                        <label class="form-check-label" for="puerta_azotea">
                                            <i class="bi bi-arrow-up me-1"></i>Azotea
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 mb-3">
                        <label class="form-label">
                            Puertas Personalizadas
                            <i class="bi bi-question-circle tooltip-icon ms-1"
                               data-bs-toggle="tooltip"
                               title="Agregue puertas adicionales espec칤ficas de su instalaci칩n"></i>
                        </label>
                        <div class="puertas-personalizadas">
                            <div class="input-group mb-2">
                                <input type="text" class="form-control puerta-personalizada"
                                       placeholder="Nombre de puerta personalizada">
                                <button class="btn btn-outline-success add-puerta-personalizada" type="button">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                            <div class="puertas-personalizadas-list"></div>
                        </div>
                    </div>
                </div>

                <!-- Horarios de Acceso -->
                <div class="row mb-3">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-clock me-2"></i>Horarios de Acceso
                        </h6>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">
                            Acceso 24/7
                            <i class="bi bi-question-circle tooltip-icon ms-1"
                               data-bs-toggle="tooltip"
                               title="쮼ste nivel tiene acceso las 24 horas?"></i>
                        </label>
                        <div class="form-check form-switch">
                            <input class="form-check-input acceso-24h" type="checkbox" name="acceso_24h"
                                   id="acceso_24h">
                            <label class="form-check-label" for="acceso_24h">
                                Acceso las 24 horas
                            </label>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3 horarios-restringidos" style="display: none;">
                        <label class="form-label">Horario Permitido</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="time" class="form-control hora-inicio" name="hora_inicio" value="08:00">
                                <small class="text-muted">Hora inicio</small>
                            </div>
                            <div class="col-6">
                                <input type="time" class="form-control hora-fin" name="hora_fin" value="18:00">
                                <small class="text-muted">Hora fin</small>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 mb-3 dias-semana" style="display: none;">
                        <label class="form-label">D칤as Permitidos</label>
                        <div class="row g-2">
                            <div class="col-md-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="lunes" id="lunes" checked>
                                    <label class="form-check-label" for="lunes">Lunes</label>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="martes" id="martes" checked>
                                    <label class="form-check-label" for="martes">Martes</label>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="miercoles" id="miercoles"
                                           checked>
                                    <label class="form-check-label" for="miercoles">Mi칠rcoles</label>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="jueves" id="jueves" checked>
                                    <label class="form-check-label" for="jueves">Jueves</label>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="viernes" id="viernes" checked>
                                    <label class="form-check-label" for="viernes">Viernes</label>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="sabado" id="sabado">
                                    <label class="form-check-label" for="sabado">S치bado</label>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="domingo" id="domingo">
                                    <label class="form-check-label" for="domingo">Domingo</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resumen del nivel -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-light border">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Nombre</strong><br>
                                    <span class="text-primary nivel-resumen-nombre">-</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Prioridad</strong><br>
                                    <span class="badge bg-info nivel-resumen-prioridad">5</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Puertas</strong><br>
                                    <span class="text-primary nivel-resumen-puertas">0 puertas</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Horario</strong><br>
                                    <span class="text-primary nivel-resumen-horario">24/7</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mensaje cuando no hay niveles -->
    <div id="no-niveles-message" class="text-center py-5">
        <i class="bi bi-key display-1 text-muted mb-3"></i>
        <h5 class="text-muted">No hay niveles de acceso configurados</h5>
        <p class="text-muted">Haga clic en "Agregar Nivel de Acceso" para comenzar a configurar los permisos del
            sistema.</p>
    </div>

    <!-- Resumen total -->
    <div id="resumen-niveles" class="card bg-primary text-white mt-4" style="display: none;">
        <div class="card-body">
            <h5 class="card-title">
                <i class="bi bi-diagram-3 me-2"></i>Resumen de Niveles de Acceso
            </h5>
            <div class="row text-center">
                <div class="col-md-3">
                    <h6>Total Niveles</h6>
                    <h4 id="total-niveles">0</h4>
                </div>
                <div class="col-md-3">
                    <h6>Acceso 24/7</h6>
                    <h4 id="total-24h">0</h4>
                </div>
                <div class="col-md-3">
                    <h6>Acceso Restringido</h6>
                    <h4 id="total-restringido">0</h4>
                </div>
                <div class="col-md-3">
                    <h6>Puertas Configuradas</h6>
                    <h4 id="total-puertas-config">0</h4>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let nivelCounter = 0;

        // Funci칩n para agregar un nuevo nivel
        function addNivel(data = null) {
            // =========================
            // 칈ndice / contador
            // =========================
            nivelCounter++;
            const index = nivelCounter - 1;

            // =========================
            // DOM base
            // =========================
            const template = document.getElementById('nivel-template');
            const container = document.getElementById('niveles-container');
            const emptyMessage = document.getElementById('no-niveles-message');
            const resumen = document.getElementById('resumen-niveles');

            const el = template.cloneNode(true);

            // =========================
            // Configuraci칩n b치sica
            // =========================
            el.id = `nivel-${nivelCounter}`;
            el.style.display = 'block';
            el.querySelector('.nivel-number').textContent = nivelCounter;

            // =========================
            // Indexar names + IDs 칰nicos
            // =========================
            el.querySelectorAll('input, select, textarea').forEach(input => {
                const baseName = input.getAttribute('name');
                if (baseName) {
                    input.name = `niveles[${index}][${baseName}]`;
                }

                if (input.id) {
                    const baseId = input.id;
                    const newId = `${baseId}_${nivelCounter}`;
                    input.id = newId;

                    const label = el.querySelector(`label[for="${baseId}"]`);
                    if (label) label.setAttribute('for', newId);
                }
            });

            // =========================
            // 游댳 Rehidrataci칩n (si hay data)
            // =========================
            if (data) {
                el.querySelector('.nivel-nombre').value =
                    data.nombre ?? '';

                el.querySelector('.nivel-prioridad').value =
                    data.prioridad ?? '5';

                el.querySelector('.nivel-descripcion').value =
                    data.descripcion ?? '';

                // Puertas est치ndar
                if (Array.isArray(data.puertas)) {
                    data.puertas.forEach(name => {
                        const checkbox = el.querySelector(`[name="${name}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }

                // Acceso 24h
                const acceso24h = el.querySelector('.acceso-24h');
                const horarios = el.querySelector('.horarios-restringidos');
                const dias = el.querySelector('.dias-semana');

                acceso24h.checked = Boolean(data.acceso_24h);

                if (!acceso24h.checked) {
                    horarios.style.display = 'block';
                    dias.style.display = 'block';

                    el.querySelector('.hora-inicio').value =
                        data.hora_inicio ?? '08:00';

                    el.querySelector('.hora-fin').value =
                        data.hora_fin ?? '18:00';
                }
            }


            // =========================
            // Insertar en DOM
            // =========================
            container.appendChild(el);

            // =========================
            // Eventos
            // =========================
            setupNivelEvents(el);

            // =========================
            // Puertas personalizadas (despu칠s de eventos)
            // =========================
            if (data && Array.isArray(data.puertas_personalizadas)) {
                const list = el.querySelector('.puertas-personalizadas-list');

                data.puertas_personalizadas.forEach(puerta => {
                    const puertaElement = document.createElement('div');
                    puertaElement.className = 'form-check mb-1';
                    puertaElement.innerHTML = `
                <input class="form-check-input" type="checkbox" checked>
                <label class="form-check-label">
                    <i class="bi bi-door-closed me-1"></i>${puerta}
                </label>
                <button type="button"
                        class="btn btn-sm btn-outline-danger ms-2 remove-puerta-personalizada">
                    <i class="bi bi-x"></i>
                </button>
            `;

                    puertaElement
                        .querySelector('.remove-puerta-personalizada')
                        .addEventListener('click', () => {
                            puertaElement.remove();
                            updateNivelResumen(el);
                            updateResumenNiveles();
                        });

                    list.appendChild(puertaElement);
                });
            }

            // =========================
            // Estado global UI
            // =========================
            emptyMessage.style.display = 'none';
            resumen.style.display = 'block';

            updateNivelResumen(el);
            updateResumenNiveles();

            return el;
        }


        // Funci칩n para configurar eventos de un nivel
        function setupNivelEvents(nivelElement) {
            // Evento para eliminar nivel
            nivelElement.querySelector('.remove-nivel').addEventListener('click', function () {
                nivelElement.remove();
                updateResumenNiveles();

                // Mostrar mensaje si no hay niveles
                const niveles = document.querySelectorAll('.nivel-item:not(#nivel-template)');
                if (niveles.length === 0) {
                    document.getElementById('no-niveles-message').style.display = 'block';
                    document.getElementById('resumen-niveles').style.display = 'none';
                }
            });

            // Contador de caracteres para descripci칩n
            const descripcionField = nivelElement.querySelector('.nivel-descripcion');
            const charCount = nivelElement.querySelector('.char-count');

            descripcionField.addEventListener('input', function () {
                const count = this.value.length;
                charCount.textContent = count;

                if (count > 500) {
                    charCount.style.color = '#dc3545';
                    this.value = this.value.substring(0, 500);
                    charCount.textContent = '500';
                } else {
                    charCount.style.color = '#6c757d';
                }

                updateNivelResumen(nivelElement);
            });

            // Toggle acceso 24/7
            const acceso24h = nivelElement.querySelector('.acceso-24h');
            const horariosRestringidos = nivelElement.querySelector('.horarios-restringidos');
            const diasSemana = nivelElement.querySelector('.dias-semana');

            acceso24h.addEventListener('change', function () {
                if (this.checked) {
                    horariosRestringidos.style.display = 'none';
                    diasSemana.style.display = 'none';
                } else {
                    horariosRestringidos.style.display = 'block';
                    diasSemana.style.display = 'block';
                }
                updateNivelResumen(nivelElement);
                updateResumenNiveles();
            });

            // Agregar puerta personalizada
            const addPuertaBtn = nivelElement.querySelector('.add-puerta-personalizada');
            const puertaInput = nivelElement.querySelector('.puerta-personalizada');
            const puertasList = nivelElement.querySelector('.puertas-personalizadas-list');

            addPuertaBtn.addEventListener('click', function () {
                const nombrePuerta = puertaInput.value.trim();
                if (nombrePuerta) {
                    const puertaElement = document.createElement('div');
                    puertaElement.className = 'form-check mb-1';
                    puertaElement.innerHTML = `
                    <input class="form-check-input" type="checkbox" name="puerta_personalizada_${Date.now()}" checked>
                    <label class="form-check-label">
                        <i class="bi bi-door-closed me-1"></i>${nombrePuerta}
                    </label>
                    <button type="button" class="btn btn-sm btn-outline-danger ms-2 remove-puerta-personalizada">
                        <i class="bi bi-x"></i>
                    </button>
                `;

                    puertasList.appendChild(puertaElement);
                    puertaInput.value = '';

                    // Evento para eliminar puerta personalizada
                    puertaElement.querySelector('.remove-puerta-personalizada').addEventListener('click', function () {
                        puertaElement.remove();
                        updateNivelResumen(nivelElement);
                    });

                    updateNivelResumen(nivelElement);
                }
            });

            // Enter en input de puerta personalizada
            puertaInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addPuertaBtn.click();
                }
            });

            // Eventos para actualizar resumen
            const inputs = nivelElement.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', function () {
                    updateNivelResumen(nivelElement);
                    updateResumenNiveles();
                });
                input.addEventListener('change', function () {
                    updateNivelResumen(nivelElement);
                    updateResumenNiveles();
                });
            });
        }

        // Funci칩n para actualizar el resumen de un nivel
        function updateNivelResumen(nivelElement) {
            const nombre = nivelElement.querySelector('.nivel-nombre').value || '-';
            const prioridad = nivelElement.querySelector('.nivel-prioridad').value || '5';
            const acceso24h = nivelElement.querySelector('.acceso-24h').checked;

            // Contar puertas seleccionadas
            const puertasSeleccionadas = nivelElement.querySelectorAll('input[type="checkbox"]:checked').length - 1; // -1 por el checkbox de 24h

            nivelElement.querySelector('.nivel-resumen-nombre').textContent = nombre;

            const prioridadBadge = nivelElement.querySelector('.nivel-resumen-prioridad');
            prioridadBadge.textContent = prioridad;

            // Color del badge seg칰n prioridad
            const prioridadColors = {
                '1': 'bg-danger', '2': 'bg-danger', '3': 'bg-warning',
                '4': 'bg-warning', '5': 'bg-info', '6': 'bg-info',
                '7': 'bg-secondary', '8': 'bg-secondary', '9': 'bg-secondary', '10': 'bg-secondary'
            };
            prioridadBadge.className = `badge ${prioridadColors[prioridad] || 'bg-info'}`;

            nivelElement.querySelector('.nivel-resumen-puertas').textContent = `${puertasSeleccionadas} puertas`;

            // Horario
            let horarioTexto = '24/7';
            if (!acceso24h) {
                const horaInicio = nivelElement.querySelector('.hora-inicio').value || '08:00';
                const horaFin = nivelElement.querySelector('.hora-fin').value || '18:00';
                horarioTexto = `${horaInicio} - ${horaFin}`;
            }
            nivelElement.querySelector('.nivel-resumen-horario').textContent = horarioTexto;
        }

        // Funci칩n para actualizar el resumen total
        function updateResumenNiveles() {
            const niveles = document.querySelectorAll('.nivel-item:not(#nivel-template)');
            let totalNiveles = niveles.length;
            let total24h = 0;
            let totalRestringido = 0;
            let totalPuertasConfig = 0;

            niveles.forEach(nivel => {
                const acceso24h = nivel.querySelector('.acceso-24h').checked;
                if (acceso24h) {
                    total24h++;
                } else {
                    totalRestringido++;
                }

                // Contar puertas configuradas
                const puertasSeleccionadas = nivel.querySelectorAll('input[type="checkbox"]:checked').length - 1;
                totalPuertasConfig += puertasSeleccionadas;
            });

            document.getElementById('total-niveles').textContent = totalNiveles;
            document.getElementById('total-24h').textContent = total24h;
            document.getElementById('total-restringido').textContent = totalRestringido;
            document.getElementById('total-puertas-config').textContent = totalPuertasConfig;
        }

        // Evento para agregar nivel
        document.getElementById('add-nivel').addEventListener('click', addNivel);


        const data = window.formularioData?.datosFormulario?.niveles_acceso || [];

        if (Array.isArray(data) && data.length > 0) {

            data.forEach(n => addNivel(n));
        } else {
            addNivel();
        }
    });
</script>
